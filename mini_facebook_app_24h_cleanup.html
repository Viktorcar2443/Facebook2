<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Facebook App</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0; padding: 0; background: #f0f2f5;
  color: #333;
}
#app {
  max-width: 600px;
  margin: auto;
  background: white;
  padding: 20px;
  min-height: 100vh;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}
.screen {
  display: none;
}
.screen.active {
  display: block;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#logged-user {
  font-weight: bold;
}
#logout-btn {
  background: #ff4d4d;
  border: none;
  padding: 6px 12px;
  color: white;
  cursor: pointer;
}
#error, .error {
  color: red;
  margin-top: 8px;
}
#post-section, #feed-section, #chat-section {
  margin-top: 20px;
  border-top: 1px solid #ccc;
  padding-top: 15px;
}
#post-text {
  width: 100%;
  height: 60px;
  resize: none;
}
#posts-container {
  margin-top: 10px;
}
.post {
  background: #fff;
  border: 1px solid #ddd;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 5px;
}
.post img {
  max-width: 100%;
  margin-top: 10px;
  border-radius: 5px;
}
.post .actions {
  margin-top: 10px;
}
.post .actions button {
  margin-right: 10px;
  cursor: pointer;
}
.comment-list {
  margin-top: 10px;
  font-size: 0.9em;
  color: #555;
  border-top: 1px solid #eee;
  padding-top: 5px;
}
.comment {
  margin-top: 5px;
}
#chat-section {
  margin-top: 30px;
}
#chat-window {
  height: 200px;
  border: 1px solid #ccc;
  padding: 8px;
  overflow-y: auto;
  background: #fafafa;
  margin-bottom: 10px;
}
.chat-message {
  margin-bottom: 8px;
}
.chat-message.self {
  text-align: right;
}
</style>
</head>
<body>
<div id="app">
  <div id="login-screen" class="screen active">
    <h2>Prijava / Registracija</h2>
    <input type="text" id="username-input" placeholder="Unesi korisničko ime" />
    <button id="login-btn">Prijavi se</button>
    <div id="login-error" class="error"></div>
  </div>

  <div id="main-screen" class="screen">
    <header>
      <h2>Mini Facebook</h2>
      <div id="logged-user"></div>
      <button id="logout-btn">Odjavi se</button>
    </header>

    <section id="post-section">
      <h3>Objavi novi status</h3>
      <textarea id="post-text" placeholder="Šta ima novo?"></textarea><br/>
      <input type="file" id="post-image" accept="image/*" />
      <button id="post-btn">Objavi</button>
    </section>

    <section id="feed-section">
      <h3>Vesti</h3>
      <div id="posts-container"></div>
    </section>

    <section id="chat-section">
      <h3>Poruke</h3>
      <select id="chat-user-select"></select>
      <div id="chat-window"></div>
      <input type="text" id="chat-input" placeholder="Piši poruku..." />
      <button id="chat-send-btn">Pošalji</button>
    </section>
  </div>
</div>

<script>
// Storage keys
const USERS_KEY = "mini_fb_users";
const POSTS_KEY = "mini_fb_posts";
const MESSAGES_KEY = "mini_fb_messages";

let currentUser = null;

// Utils
function saveUsers(users) {
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
}
function loadUsers() {
  return JSON.parse(localStorage.getItem(USERS_KEY) || "[]");
}
function savePosts(posts) {
  localStorage.setItem(POSTS_KEY, JSON.stringify(posts));
}
function loadPosts() {
  return JSON.parse(localStorage.getItem(POSTS_KEY) || "[]");
}
function saveMessages(messages) {
  localStorage.setItem(MESSAGES_KEY, JSON.stringify(messages));
}
function loadMessages() {
  return JSON.parse(localStorage.getItem(MESSAGES_KEY) || "[]");
}

// Login / Register
const loginScreen = document.getElementById("login-screen");
const mainScreen = document.getElementById("main-screen");
const usernameInput = document.getElementById("username-input");
const loginBtn = document.getElementById("login-btn");
const loginError = document.getElementById("login-error");
const loggedUserElem = document.getElementById("logged-user");
const logoutBtn = document.getElementById("logout-btn");

loginBtn.onclick = () => {
  const username = usernameInput.value.trim();
  if (!username) {
    loginError.textContent = "Unesi korisničko ime.";
    return;
  }
  let users = loadUsers();
  let user = users.find(u => u.username === username);
  if (!user) {
    user = { username };
    users.push(user);
    saveUsers(users);
  }
  currentUser = user;
  loginScreen.classList.remove("active");
  mainScreen.classList.add("active");
  usernameInput.value = "";
  loginError.textContent = "";
  loggedUserElem.textContent = currentUser.username;
  refreshFeed();
  refreshChatUserSelect();
  clearChat();
};

logoutBtn.onclick = () => {
  currentUser = null;
  loginScreen.classList.add("active");
  mainScreen.classList.remove("active");
};

// Posts
const postText = document.getElementById("post-text");
const postImageInput = document.getElementById("post-image");
const postBtn = document.getElementById("post-btn");
const postsContainer = document.getElementById("posts-container");

postBtn.onclick = () => {
  const text = postText.value.trim();
  if (!text && !postImageInput.files.length) {
    alert("Napiši tekst ili izaberi sliku.");
    return;
  }
  let posts = loadPosts();
  let imgData = null;

  if (postImageInput.files.length) {
    const file = postImageInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      imgData = e.target.result;
      addPost(text, imgData);
    };
    reader.readAsDataURL(file);
  } else {
    addPost(text, null);
  }

  function addPost(text, img) {
    posts.unshift({
      id: Date.now(),
      username: currentUser.username,
      text,
      image: img,
      likes: [],
      comments: []
    });
    savePosts(posts);
    postText.value = "";
    postImageInput.value = "";
    refreshFeed();
  }
};

function refreshFeed() {
  let posts = loadPosts();
  postsContainer.innerHTML = "";
  for (const post of posts) {
    const postDiv = document.createElement("div");
    postDiv.className = "post";

    const author = document.createElement("b");
    author.textContent = post.username;
    postDiv.appendChild(author);

    if (post.text) {
      const p = document.createElement("p");
      p.textContent = post.text;
      postDiv.appendChild(p);
    }
    if (post.image) {
      const img = document.createElement("img");
      img.src = post.image;
      postDiv.appendChild(img);
    }

    const actionsDiv = document.createElement("div");
    actionsDiv.className = "actions";

    const likeBtn = document.createElement("button");
    likeBtn.textContent = "Lajkuj (" + post.likes.length + ")";
    likeBtn.onclick = () => {
      if (!post.likes.includes(currentUser.username)) {
        post.likes.push(currentUser.username);
      } else {
        post.likes = post.likes.filter(u => u !== currentUser.username);
      }
      savePosts(posts);
      refreshFeed();
    };
    if (post.likes.includes(currentUser.username)) {
      likeBtn.style.fontWeight = "bold";
      likeBtn.style.color = "blue";
    }
    actionsDiv.appendChild(likeBtn);

    const commentInput = document.createElement("input");
    commentInput.type = "text";
    commentInput.placeholder = "Komentariši...";
    commentInput.className = "comment-input";
    commentInput.onkeypress = (e) => {
      if (e.key === "Enter") {
        const val = commentInput.value.trim();
        if (val) {
          post.comments.push({ username: currentUser.username, text: val });
          savePosts(posts);
          refreshFeed();
        }
      }
    };
    actionsDiv.appendChild(commentInput);
    postDiv.appendChild(actionsDiv);

    if (post.comments.length > 0) {
      const commentList = document.createElement("div");
      commentList.className = "comment-list";
      for (const c of post.comments) {
        const commentDiv = document.createElement("div");
        commentDiv.className = "comment";
        commentDiv.textContent = c.username + ": " + c.text;
        commentList.appendChild(commentDiv);
      }
      postDiv.appendChild(commentList);
    }
    postsContainer.appendChild(postDiv);
  }
}

// Chat
const chatUserSelect = document.getElementById("chat-user-select");
const chatWindow = document.getElementById("chat-window");
const chatInput = document.getElementById("chat-input");
const chatSendBtn = document.getElementById("chat-send-btn");

function refreshChatUserSelect() {
  const users = loadUsers().filter(u => u.username !== currentUser.username);
  chatUserSelect.innerHTML = "";
  if (users.length === 0) {
    const option = document.createElement("option");
    option.textContent = "Nema drugih korisnika";
    option.disabled = true;
    chatUserSelect.appendChild(option);
  } else {
    for (const u of users) {
      const option = document.createElement("option");
      option.value = u.username;
      option.textContent = u.username;
      chatUserSelect.appendChild(option);
    }
  }
}

function loadChatMessages(user1, user2) {
  let messages = loadMessages();
  return messages.filter(m =>
    (m.from === user1 && m.to === user2) ||
    (m.from === user2 && m.to === user1)
  ).sort((a, b) => a.timestamp - b.timestamp);
}

function clearChat() {
  chatWindow.innerHTML = "";
  chatInput.value = "";
}

function refreshChat() {
  const chatWith = chatUserSelect.value;
  if (!chatWith) {
    chatWindow.innerHTML = "";
    return;
  }
  const messages = loadChatMessages(currentUser.username, chatWith);
  chatWindow.innerHTML = "";
  for (const msg of messages) {
    const div = document.createElement("div");
    div.className = "chat-message";
    if (msg.from === currentUser.username) div.classList.add("self");
    div.textContent = msg.from + ": " + msg.text;
    chatWindow.appendChild(div);
  }
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

chatUserSelect.onchange = refreshChat;

chatSendBtn.onclick = () => {
  const chatWith = chatUserSelect.value;
  const text = chatInput.value.trim();
  if (!chatWith) {
    alert("Izaberi korisnika za dopisivanje.");
    return;
  }
  if (!text) {
    alert("Napiši poruku.");
    return;
  }
  let messages = loadMessages();
  messages.push({
    from: currentUser.username,
    to: chatWith,
    text,
    timestamp: Date.now()
  });
  saveMessages(messages);
  chatInput.value = "";
  refreshChat();
};
// Automatsko brisanje svakih 24h
const now = new Date().getTime();
const lastCleanup = localStorage.getItem("lastCleanup");

if (!lastCleanup || now - parseInt(lastCleanup) > 24 * 60 * 60 * 1000) {
  localStorage.removeItem("posts");
  localStorage.removeItem("messages");
  localStorage.setItem("lastCleanup", now.toString());
  console.log("Podaci su očišćeni jer je prošlo 24h.");
}
</script>
</body>
</html>